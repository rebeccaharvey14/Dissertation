\chapter{Chapter 4. Grad-Shafranov reconstruction and automated identification of magnetic structures} \label{ch:ch4}

\section{The Grad-Shafranov equation}
%\input{Chapters/Introduction/GS_equation}
The Grad-Shafranov (GS) equation, $\nabla^2 A = \frac{\mathrm{d}^2 A}{\mathrm{d}x^2} + \frac{\mathrm{d}^2 A}{\mathrm{d}y^2} = -\mu_0 \frac{\mathrm{d}P_t}{\mathrm{d}A} = - \mu_0\frac{\mathrm{d}}{\mathrm{d}A}\left(p + \frac{B_z^2}{2\mu_0}\right)$, describes the force balance between the Lorentz force and the gradient of the thermal pressure \citep{Sonnerup:1996, Hau:1999}, as given below,
\eql{eq:GS}{\delsq A = \npdv{2}{A}{x} + \npdv{2}{A}{y} = -\mu_0 \dv{P_t}{A} = - \mu_0\dv{}{A}\p{p + \frac{B_z^2}{2\mu_0}}.}

\subsection{Derivation of the original GS equation}
Starting with the magnetic field as a function of the magnetic vector potential and balancing the gradient of the pressure with the Lorentz force,
\eql{eq:B}{\Bvec = \delcross\Avec = \del\Avec\cross\zhat + B_z\zhat}
\eql{eq:gradp}{\grad p = \jvec\cross\Bvec = j_z\zhat\cross\Bvec_\perp + \jvec_\perp\cross B_z\zhat}

\noindent Using Ampere's law to determine the components of the current density $\jvec$,
\eql{eq:Amperes}{\begin{split}
    \delcross\Bvec &= \mu_0\jvec \\
    \delcross\p{\delcross\Avec} & = \mu_0\jvec \\
    \delcross\pp{\grad\Avec\cross\zhat + B_z\zhat} &= \mu_0\pp{j_z\zhat + \jvec_\perp} \\
\end{split}}
The $\zhat$ and perpendicular components of the current density are then found by,
\eql{eq:jz}{\begin{split}
    \mu_0 j_z\zhat &= \delcross\p{\grad\Avec\cross\zhat} \\
    &= \p{\deldot\zhat}\grad\Avec - \p{\deldot\del\Avec}\zhat \\
   j_z\zhat &= -\frac{1}{\mu_0}\delsq\Avec\zhat \\
\end{split}}
\eql{eq:jperp}{\begin{split}
    \jvec_\perp &= \frac{1}{\mu_0}\delcross B_z\zhat \\
    &= \frac{1}{\mu_0}\grad B_z\cross\zhat \\
\end{split}}

\noindent Simplfying the $\zhat$ (\ref{eq:jz}) and perpendicular (\ref{eq:jperp}) components of the current density,
\eql{eq:jzBperp}{\begin{split}
    j_z\zhat \cross\Bvec_\perp &= -\frac{1}{\mu_0}\delsq\Avec\zhat\cross\p{\grad\Avec\cross\zhat} \\
    &= -\frac{1}{\mu_0}\pp{\p{\delsq\Avec\zhat\cdot\zhat}\del\Avec - \p{\delsq\Avec\zhat\cdot\grad\Avec}\zhat} \\
    &= -\frac{1}{\mu_0}\p{\delsq\Avec} \grad\Avec \\
\end{split}}
\eql{eq:jperpBz}{\begin{split}
    \jvec_\perp\cross B_z\zhat &= \p{\frac{1}{\mu_0}\grad B_z\cross\zhat}\cross B_z\zhat \\
    &= \frac{1}{\mu_0}\pp{\p{\zhat\cdot\del}B_z\zhat - \p{B_z\zhat\cdot B_z\zhat}\del} \\
    &= -\frac{1}{\mu_0}B_z\grad B_z
\end{split}}

\noindent and substituting them into the respective right hand side terms of the pressure gradient (\ref{eq:gradp}) we arrive at the form for the Grad-Shafranov equation (\ref{eq:GS}):
\eq{\begin{split}
    \grad p &= -\frac{1}{\mu_0}\p{\delsq\Avec}\grad\Avec - \frac{1}{\mu_0}B_z\grad B_z \\
    \p{\delsq\Avec}\grad\Avec &= -\mu_0\p{\grad p+ \frac{1}{\mu_0}B_z\grad B_z} \\
    \p{\delsq\Avec}\grad\Avec &= -\mu_0 \p{\dv{p}{A}\grad\Avec + \frac{1}{\mu_0}B_z\dv{B_z}{A}\grad\Avec} \\
    \delsq\Avec &= -\mu_0\p{\dv{p}{A} + \frac{1}{\mu_0}\dv{B_z}{A}} \\
\end{split}}

\eql{eq:gradp2}{\delsq\Avec = -\mu_0\dv{}{A}\p{p + \frac{B_z^2}{2\mu_0}}}

\subsection{Derivation of the extended GS equation}
The implementation by \cite{Chen:2021} utilizes the extended GS method, which still seeks to find the double-folding pattern between two $P_t'$ versus $A'$ curves, but with $A'=(1-\alpha)A$ and $P_t'=\p{1-\alpha}p + \p{1-\alpha}^2\frac{B_z^2}{2\mu_0} + \alpha\p{1-\alpha}\frac{B^2}{2\mu_0}$.  The factor $\alpha$ is a proportionality constant, which for a field-aligned flow is the average Alfv\'en Mach number squared, $\alpha=\langle M_A\rangle^2 \approx const$ in a frame of reference moving with the structure governed by the GS equation. The extended GS equation \citep{Teh:2018} is:
\begin{equation}
    \nabla^2 A' = -\mu_0\frac{\mathrm{d}}{\mathrm{d}A'}\left[\left(1-\alpha\right)p + \left(1-\alpha\right)^2\frac{B_z^2}{2\mu_0} + \alpha\left(1-\alpha\right)\frac{B^2}{2\mu_0} \right]
    \label{eq:GSextended}
\end{equation}
which simplifies to the original GS equation (\ref{eq:GS}) when $\alpha\equiv 0$. The extended GS method allows us to identify structures with significant remaining plasma ï¬‚ow aligned with the local magnetic field in a proper frame of reference \citep{Chen:2022}.

\section{Automated detection of flux ropes from GS detection}
In both the original and the GS-type equations, the transverse pressure $P_t$, and its equivalent $P_t'$, are single variable functions of the magnetic flux function $A$ ($A'$ for the GS-type with $\alpha\equiv const$). With this feature, one can recover the 2D cross-section of a flux rope structure from the 1D spacecraft data by solving the initial value problem based on the GS equation, i.e., by carrying out the GS reconstruction procedures \citep{Hau:1999, HuSonnerup:2002, Hu:2017}. The GS-based techniques in this study consist of the GS-type reconstruction and the extended GS-based automated detection. Considering the complicated environment from the solar wind to the magnetosheath, we adopt the GS-type reconstruction in this study for selected events only.

A cross section of a cylindrical flux rope structure is fully characterized by the 2D scalar flux function $A(x, y)$, and the field-line invariants $\p{B_z,J_z,p, P_t}$ vary among the nested cylindrical flux surfaces while remaining constant on each distinct surface with a distinct $A$ value \citep{Hu:2018}. As a spacecraft passes through the cross section of a magnetic flux rope with closed transverse field lines, it crosses the same set of magnetic field lines twice, the second time being in reverse order as the first half of the crossing. Therefore, the measured magnetic flux function $A$ associated with the field lines traversed by the spacecraft is double-folded, meaning there is a turning point at which an extremum in $A$ is reached. These features, especially the double-folding pattern, are the basis for the GS reconstruction-based identification algorithm \citep{Hu:2018}. Figure \ref{fig:GSreconstruction_Hu2017} shows diagram of a reconstruction of a magnetic cloud event and the associated flux rope structure. The cross section from the reconstruction algorithm can be seen as well as its relation to the magnetic field lines of the flux rope structure.
% extended method vs original method
A more detailed description of the implementation \citep{Hu:2018}, including a flowchart of the flux rope detection algorithm, can be found in Appendix \ref{ch:gs-flowchart}, and online\footnote{\url{fluxrope.info/flowchart.html}}.

\begin{figure}
    \centering
    \includegraphics[width=0.75\textwidth]{Figures/Hu2017_5a.png}
    \caption[2D cross section view of a flux rope structure reconstruction] {View of a flux rope structure reconstruction for a magnetic cloud event \citep{Hu:2015} as a spacecraft passes through it. The 2D cross section and selected associated magnetic field lines (red and blue twisted lines) along the flux rope axis ($z$-axis). $A_m$ and $A_b$ mark the magnetic flux function $A$ at the center and boundary, respectively, of the reconstruction. The poloidal flux can also be obtained through the reconstruction algorithm.} %$\PHhi_p = |A_m-A_b|\cdot L_{eff}$ along the effective length of the $z$-axis (shaded portion)
    \label{fig:GSreconstruction_Hu2017}
\end{figure}


The automated detection algorithm moves through different windowed periods of the data, with each window identifying events of certain duration. We employ windows with a minimum duration from approximately 30 seconds (10$\Delta t$) to a maximum duration of 343 data points, which corresponds to approximately 17 minutes for THEMIS data, and 25 min for MMS data. In order to identify two-dimensional magnetic structures from single-spacecraft data \citep{Paschmann:2008}, the \textit{in situ} magnetic field and plasma data from a specified window of time are transformed into the co-moving frame, notably the de Hoffman-Teller frame \citep{deHoffman-Teller:1950}. Through a trial-and-error process to determine the optimal orientation of the $z$-axis, the azimuthal and poloidal angles that define this frame transformation are chosen. The azimuthal angle $\phi$ is the longitude of the FR $z$-axis, which measures the angle between the $x$-direction and the projection of the $z$-axis onto the $xy$-plane. The polar angle $\theta$ is the angle between the FR $z$-axis and the GSE $z$-direction. %The azimuthal angle $\Phi$ is the rotational angle around the $z$-axis (in the $xy$-plane), and polar angle $\theta$ is the angle between the $z$-axis and the velocity vector of the spacecraft.
The data are then used to calculate the transverse pressure $P_t'(A')$ as a function of the scalar flux function, $A'$. If the $P_t'$ versus $A'$ is double folded through a flux rope interval, then two metrics, $R_{diff}$ (the point-wise difference between the two folds) and $R_{fit}$ (a fitting residue of $P_t'(A')$), are used to check the double-folding quality and the shape of $P_t'(A')$. The threshold values for these metrics are selected empirically to guarantee good flux rope quality \citep{Hu:2018}, and if the thresholds are met, the event is recorded as an event candidate. If the thresholds are not met, the z-axis will go through its next iteration until the thresholds are met.

After the initial detection of candidates, the list is cleaned by removing the events that do not meet the two residue thresholds, $R_{diff}<0.2$ and $R_{fit}<0.2$. The records are then examined using the Wal\'en test slope $k$, the slope of the linear regression between $\mathbf{V_{sw}} - \mathbf{V_{HT}}$ and $\mathbf{V_A}$, to further distinguish Alfv\'enic structures. This study uses a threshold for the Wal\'en test slope $k=0.3$; therefore, we keep the records with $|k|<0.3$, and remove the records with $|k|>0.3$, except for when the correlation coefficient $r$ between $\mathbf{V_{sw}} - \mathbf{V_{HT}}$ and $\mathbf{V_A}$ is $|r|\geq 0.8$ and the Mach number average $\langle M_A\rangle \leq 0.9$. The conditions $|r|\geq 0.8$ and $\langle M_A\rangle \leq 0.9$ arise for $|k|>0.3$ to ensure that the remaining plasma flow is aligned with the local magnetic field, and so that we avoid a singularity at $\alpha=1$. Events with $\alpha>1$ are also removed, so that the events remaining are sub-Alfv\'enic. Table \ref{tab:thresholds} lays out the threshold conditions used in the post-processing of the GS detection event lists. The code and software used to reconstruct the 2D cross-section of the events can be found at \url{https://github.com/PyGSDR/PyGS}.
\input{Tables/thresholds}

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{Figures/Reconstructions/Hu2015_GSreconstruction.png}
    \caption[GS 2D reconstruction of a magnetic cloud]{Reconstruction of a magnetic cloud \citep{Hu:2015}: a) 2D cross section of $A(x,y)$ for a reconstructed magnetic cloud event. The black lines indicate the transverse magnetic field lines, and the color bar indicates the axial field lines $B_z$. The yellow arrows denote the transverse field lines ($B_t$) along the path of the spacecraft ($y=0$). The white contour indicates the area of the reconstruction done from spacecraft data ($A=A_b$), while the area outside the white contour is reconstructed from extrapolation. b) 3D view of a flux rope structure for the magnetic cloud event, showing the 2D cross section (A') and selected associated twisted magnetic field lines along the flux rope axis (denoted at the top). The black field lines  rooted at the foot points where the electron onsets were observed. The pink and blue circles denote the locations where the associated field lines complete a full turn around the z-axis.}
    \label{fig:GSreconstruction_Hu2015}
\end{figure}

%Such an extended version searches FRs including those with significant field-aligned flows as they also meet the broad definition of magnetic flux ropes, \textit{i.e}., having twisted field lines around the central axis \citep{Chen:2021}. Therefore, the Alfv\'enicity of these dynamic structures is not negligible, which will be characterized by the $M_A$ and the Wal\'en test slope.

\section{Wal\'en test and Alfv\'enicity}
The Wal\'en test slope $k$, the slope of the linear regression between $\mathbf{V_{sw}} - \mathbf{V_{HT}}$ and $\mathbf{V_A}$, is then used to further distinguish Alfv\'enic structures

%generalized test is most simply formulated as a vector difference equation relating changes in the electron velocity vector and changes of the magnetic field vector, with a prescribed scalar constant of proportionality.

\section{Analysis results}
\begin{figure}
    \centering
    \includegraphics[width=0.45\linewidth]{Figures/GS analysis/walenTest_vs_crosshelicity_solarwind.png}
    \includegraphics[width=0.45\linewidth]{Figures/GS analysis/walenTest_vs_crosshelicity_magnetosheath.png}
    \caption[Wal\'en test slope vs. reduced cross helicity]{Caption}
    \label{fig:walen-crosshelicity}
\end{figure}


\begin{figure}
    \centering
    \includegraphics[width=0.45\linewidth]{Figures/GS analysis/heatmap_solarwind.png}
    \includegraphics[width=0.45\linewidth]{Figures/GS analysis/heatmap_magnetosheath.png}
    \caption[2D distributions of various parameters vs. $|A_m|$]{Caption}
    \label{fig:heatmap-A}
\end{figure}