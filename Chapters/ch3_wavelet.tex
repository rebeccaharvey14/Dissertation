\chapter{Chapter 3. Wavelet analysis as a single-spacecraft method}

\section{Wavelet analysis}
%\input{Chapters/Introduction/wavelet}

\subsection{Wavelet transforms}
Wavelet transforms are used to analyze time series with non-stationary power at different frequencies \cite{Torrence:1998}. Continuous wavelet transforms use non-orthogonal wavelet basis functions. Assuming  an equally spaced time series $x_n=x(t_n)$ with time resolution $\delta t$, the continuous wavelet transform is
\begin{equation}
    W(s,\tau) = \frac{1}{|s|^{1/2}}\int_{-\infty}^\infty x_n\psi^*\p{\frac{t-\tau}{s}}\textnormal{dt}
    \label{wavetrans}
\end{equation}
where $\psi^*$ is the complex conjugate of the wavelet basis function $\psi(t)$, which is a function that must be localized in time and frequency space, and have zero mean \citep{Torrence:1998}. Figure \ref{fig:wavelet-diagram} visually demonstrates the transform of a time series data set from the time domain to a time-frequency domain.

\begin{figure}
    \centering
    \includegraphics[width=0.7\textwidth]{Figures/Comparisonoftransformations.jpeg}
    \caption[Time and frequency resolutions of different transforms]{Time and frequency resolutions of different transforms applied to a one-dimensional time series dataset. The wavelet transform (bottom right) has non-uniform frequency and time resolution.}
    \label{fig:wavelet-diagram}
\end{figure}

\noindent Approximating \eqref{wavetrans} with a discrete set of data $x_n$, the wavelet transform takes the form %scaled and translated
\begin{equation}
    W_n(s,t) = \sum_{n'=0}^{N-1}x_{n'}\psi^*\pp{\frac{\p{n'-n}\delta t}{s}}
    \label{eq:wavetrans2}
\end{equation}
Dilating the scale $s$ and translating along time $n$ will give the two dimensions to the resulting array. The scales are chosen such that
\eq{J = \frac{\log_2\p{\frac{N dt}{s_0}}}{dj}}
\eql{scales}{s_j = s_0 2^{j dj},\hspace{20pt} j = 0,...,J}
where $s_0 = 2dt$ and the choice of $dj$ is sufficiently small for the width of the wavelet basis function in spectral space. The Morlet wavelet \eqref{morlet} is a good wavelet base because it is complex and has good frequency resolution, thus it is frequently used in small-scale flux rope identification \citep{Telloni:2012, Telloni:2013, Zhao:2020}.
\eql{morlet}{\psi_0(\eta) = \pi^{-1/4}e^{i\omega_0\eta}e^{-\eta^2/2}}

% The calculation in (\ref{eq:wavetrans2}) can be more efficiently done in Fourier space. Using a discrete Fourier transform, all $N$ convolutions can be done simultaneously for each scale $s$. The discrete Fourier transforms of the time series $\xhat_k=x_n$ and $\psihat^*(s\omega_k)=\psi^*(s,t)$ are
% \eql{DFTx}{\xhat_k = \frac{1}{N}\sum_{n=0}^{N-1}x_n e^{-2\pi ikn/N}}

% \eql{DFTpsi}{}

% By the convolution theorem, a wavelet transform is inverse Fourier transform of the product
% \eql{wavelet}{W_n(s,t) =\sum_{k=0}^{N-1} \xhat_k \psihat^*\p{s\omega_k} e^{i\omega_k n\delta t}}
% where

\subsection{MHD quantities}
The magnetic field lines in flux ropes are twisted such that they preside in a tube-like configuration. Thus, flux ropes carry magnetohydrodynamic (MHD) quantities such as cross helicity $H_c$ and magnetic helicity $H_m$, as well as residual energy $E_r$, defined as
\begin{equation}
    H_c = \frac{1}{2}\int \mathbf{v}\cdot\mathbf{b} \hspace{5pt} \mathrm{d^3} \mathbf{r}
    \label{eq:Hc}
\end{equation}
\begin{equation}
    H_m = \int \mathbf{A}\cdot\mathbf{B} \hspace{5pt} \mathrm{d^3} \mathbf{r}
    \label{eq:Hm}
\end{equation}
\begin{equation}
    E_r = \frac{1}{2} \pp{\pang{\mathbf{v}^2}  - \pang{\mathbf{b}^2}},
    \label{eq:Er}
\end{equation}
where $\mathbf{B}\p{\mathbf{x},t}$ is the magnetic field, $\mathbf{A}\p{\mathbf{x},t}$ is the magnetic vector potential, and $\mathbf{v}(\mathbf{x},t)$ and $\mathbf{b}(\mathbf{x},t)$ are the fluctuating velocity and magnetic field in Alfv\'en units. Cross helicity describes the measure of alignment between magnetic and velocity fluctuations, while magnetic helicity describes the “knottedness” of the magnetic field lines \citep{Matthaeus:1982}. High magnetic helicity is a signature of flux ropes, and often accompanied by low cross helicity \citep{Zhao:2020}. Residual energy describes the imbalance between magnetic and kinetic energy, and thus according to \eqref{eq:Er}, a negative residual energy will characterize an event with higher magnetic energy.
%When normalized, these magnetohydrodynamic quantities give insight into the nature of magnetic field structures, and allow us to identify these events in the solar wind and Earth's magnetosphere.

Normalized MHD quantities give insight into the nature of magnetic field structures, and allow us to identify and characterize these events. Approximated in the time domain, the normalized cross helicity and residual energy can be calculated using
\eql{eq:sigctime}{\sigma_c = \frac{2\langle\mathbf{v}\cdot\mathbf{b}\rangle}{\langle\mathbf{v}^2\rangle + \langle\mathbf{b}^2\rangle}}
\eql{eq:sigrtime}{\sigma_r = \frac{\langle\mathbf{v}^2\rangle - \langle\mathbf{b}^2\rangle}{\langle\mathbf{v}^2\rangle + \langle\mathbf{b}^2\rangle}}
where $\mathbf{v}$ is the remaining flow in the de Hoffman-Teller frame. Single spacecraft measurements cannot be used directly calculate reduced magnetic helicity, therefore other methods are required to approximate this quantity. The power spectral density of a time series describes the distribution of the energy across the frequency components of a signal. \cite{Matthaeus:1982} showed that a form of the magnetic helicity can be calculated using single spacecraft measurements by utilizing the power spectral density. This can often be done in a similar fashion using wavelet transforms \citep{Telloni:2012, Telloni:2013}. The continuous wavelet transform of a one-dimensional time series yields the two-dimensional time-scale spectrogram for a finite time period. This shows how the amplitude of a feature versus the scale varies with time, therefore making it useful in studying the features associated with multi-scale structures. The so-called reduced form of the magnetic helicity gives quantitative information about the magnetic helicity density along the radial dimension, $x$, and is calculated with Fourier transforms of the $y$- and $z$-components of the magnetic field, $\tilde{F}(B_y)$ and $\tilde{F}(B_z)$,
\begin{equation}
    H_m(k) = \frac{2 \textnormal{Im}\pp{S_{yz} (k)}}{k} = \frac{2 \textnormal{Im}\pp{\tilde{F}^*(B_y)\tilde{F}(B_z)}}{k}
\end{equation}
where $S_{yz}(k)$ is one element of the reduced magnetic power spectral density tensor \citep{Matthaeus:1982}. \cite{Telloni:2012} showed that taking $x$ along the radial direction from the sun, wavelet transforms of the magnetic field $y$- and $z$-components, the Els\"asser variables $z^\pm$, and kinetic and magnetic energies enable an efficient way to calculate the reduced normalized magnetic helicity $\sigma_m$, cross helicity $\sigma_c$, and residual energy $\sigma_r$, corresponding to equations (\ref{eq:Hc})-(\ref{eq:Er}):
\begin{equation}
    \sigma_m(k,t) = 2\frac{\textnormal{Im}\pp{W_y^*(k,t)W_z(k,t)}}{|W_y(k,t)|^2 + |W_z(k,t)|^2} ,
    \label{eq:sigm}
\end{equation}
\begin{equation}
        \sigma_c(k,t) = \frac{W^+(k,t)-W^-(k,t)}{W^+(k,t)+W^-(k,t)} ,
        \label{eq:sigc}
\end{equation}
 \begin{equation}
    \sigma_r(k,t) = \frac{W_{kin}(k,t) - W_{mag}(k,t)}{W_{kin}(k,t) + W_{mag}(k,t)} .
    \label{eq:sigr}
\end{equation}

\noindent where $W_x(k,t),W_y(k,t),W_z(k,t),W^+(k,t)$, and $W^-(k,t)$ are the wavelet transforms of $B_x,B_y,B_z,z^+$, and $z^-$, respectively. The Els\"asser variables, $z^\pm = \mathbf{v} \pm \mathbf{b}$, are the combination of the velocity and magnetic field fluctuations in Alfv\'en units. $W_{kin}(k,t)$ and $W_{mag}(k,t)$ are the sums of the power of the wavelet transforms of the components of the velocity and magnetic field (in Alfv\'en units).


% \begin{equation}
%   \label{example}
%   \begin{split}
%    \nabla \cdot \nabla \psi &= \frac{\partial^2 \psi}{\partial x^2} + \frac{\partial^2 \psi}{\partial y^2} + \frac{\partial^2 \psi}{\partial z^2} \\
%    &= \frac{1}{r^2 \sin\theta} \left[ \sin\theta \left( r^2 \frac{\partial \psi}{\partial r} \right) + \frac{\partial}{\partial \theta} \left( \sin \theta  \frac{\partial \psi}{\partial r} \right) + \frac{1}{\sin \theta} \frac{\partial^2 \psi}{\partial \varphi^2}  \right] 
%      \end{split}
% \end{equation}

\section{Algorithm for identification of magnetic structures} \label{sec:wavelet-algorithm}
Figure \ref{fig:wavelet-spectrograms-mms} shows time series data and the corresponding spectrograms of the reduced MHD quantities from equations (\ref{eq:sigm})-(\ref{eq:sigr}). These spectrograms show how the reduced MHD quantities vary in time and frequency, thus allowing us to search them for characteristics that are distinctive to different types of magnetic structures. Panel (f) of Figure \ref{fig:wavelet-spectrograms-mms} displays the spectrogram reduced magnetic helicity, which describes the “knottedness” of the magnetic field lines. Panel (g) shows the normalized measure of alignment between magnetic and velocity fluctuations, reduced cross helicity, and panel (h) shows the imbalance between magnetic and kinetic energy, or reduced residual energy \citep{Matthaeus:1982}.

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{Figures/Time series/spectrograms_09112019_1020_MMS1.png}
    \caption[Time series data and spectrograms of MHD quantities for 9 November 2019]{Time series of (a) magnetic field, (b) velocity, (c) plasma density and temperature, (d) Alfv\'en speed and velocity fluctuations, (e) plasma beta, and spectrograms of the normalized (f) reduced magnetic helicity, (g) cross helicity, and (h) residual energy found by wavelet analysis, across multiples scales (as indicated by the vertical axes), during a 3 hour period that MMS-1 was in the magnetosheath on 9 November 2019. White contours in panel (f) and (g) represent regions of high reduced magnetic helicity ($|\sigma_m| \geq 0.75$) and regions of low reduced cross helicity ($|\sigma_c| \leq 0.3$), respectively. The black curved line in panels (f)-(h) is the cone of influence.}
    \label{fig:wavelet-spectrograms-mms}
\end{figure}

Structures with local enhanced magnetic helicity are identified with specific criteria: (i) magnetic helicity with absolute values greater than 0.75, (ii) duration between 30 seconds and 6 hours, and (iii) if the event was within the cone of influence, which arises because of finite data segment length \citep{Torrence:1998}. We calculate reduced, normalized forms of magnetic helicity $\sigma_m$, cross helicity $\sigma_c$, and residual energy $\sigma_r$ in 2400-point windows ($\sim$3 hours for MMS and $\sim$2 hours for THEMIS) across the hours-long periods identified in the solar wind and magnetosheath. Figure \ref{fig:spectrograms-interval} displays the spectrograms of reduced magnetic helicity from 10:20-13:30 UT and 11:05-14:05 UT on 9 November 2019. These intervals are calculated from the time series in Figure \ref{fig:wavelet-spectrograms-mms}. Events identified with the wavelet analysis method are marked with a grey interval on the bottom panel, and events from the GS reconstruction analysis are marked on the top panel. For the wavelet analysis panel, the black contours represent event candidates with $|\sigma_m|\geq 0.75$ whereas the white contours indicate events that were established in the final event list. Inside the white contours, a white ``X" marks the absolute local maximum, and the yellow annotations and dashed lines indicate the scale corresponding to a maximum. This scale is taken as the duration of the event, and the time of the peak in reduced $\sigma_c$ is taken to the time-wise midpoint of the event. Therefore, the event interval start time will be the time of the peak in $|\sigma_m|$ minus half of the scale size of the peak. The events identified from this wavelet analysis can be further characterized by implementing the criteria that the events have (iv) corresponding cross helicity with absolute value less than 0.3, to ensure that there is low level of velocity fluctuations and/or (v) negative residual energy, which indicates that the magnetic energy is dominant.
\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{Figures/Spectrograms/magnetichelicity_wave_events_09112019_1020.png}
    \includegraphics[width=\textwidth]{Figures/Spectrograms/magnetichelicity_wave_events_09112019_1105.png}
    \caption[Diagram of wavelet analysis identification algorithm via spectrograms of MHD quantities]{Spectrograms of reduced magnetic helicity over two overlapping 3-hour period from MMS-1 data on 9 November 2019. Demarcated intervals are identified events via wavelet analysis. Black contours represent regions of high reduced magnetic helicity ($|\sigma_m| \geq 0.75$). White contours represent regions of $|\sigma_m| \geq 0.75$ where the maximum inside the contour is an established event. Yellow dashed lines connect the maximum of the contour to the x-axis (scale) of the maximum. Red arrows indicate half of the scale (duration) on either side of the peak of $\sigma_c$. The black curved line is the cone of influence.}
    \label{fig:spectrograms-interval}
\end{figure}

It can be seen that not all grey event intervals have a white contour and marker for the maximum $\sigma_c$. This is because of the windowed analysis: as the maxima in reduced magnetic helicity are recorded in each window, there will be overlapping events identified. The intervals in Figure \ref{fig:spectrograms-interval} are overlapping by 600 data points (45 minutes for MMS data). After all the windows are searched, the compiled event list is then processed to eliminate overlapping events. % by comparing two adjacently overlapping events and keeping the one with the highest maximum in $|\sigma_m|$. This is repeated until there are no overlapping events left.


\section{Results}
Since the specificity of the wavelet analysis identification method relies on factors such as data segment length and choice of wavelet basis, in addition to ..., calculations of scale size cannot be considered as physically reliable as the calculations from the GS-based method.


Table \ref{tab:wavelet-event-summary} categorizes the events identified via wavelet analysis based on meeting certain MHD criteria. Over half of the events in the solar wind have characteristics of static flux ropes ($|\sigma_m|\geq 0.75$, $|\sigma_c|\leq 0.3$, $\sigma_r<0$), whereas in the magnetosheath there are fewer events (approximately one-third) that meet these criteria.

\begin{table}[h]
    \centering
    \input{Tables/wavelet_summary}
    \caption{Summary table of events meeting certain MHD criteria for events identified via wavelet analysis in the magnetosheath and solar wind.}
\end{table}